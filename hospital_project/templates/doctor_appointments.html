{% extends 'doctor_navbar.html' %}
{% load static %}
{% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    table th {
        background: #008474;
        color: white;
        text-align: center;
        padding: 12px;
        white-space: nowrap;
    }

    table td {
        text-align: center;
        vertical-align: middle;
        padding: 12px;
        white-space: nowrap;
    }

    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* MOBILE FIX */
    @media (max-width: 768px) {
        table th,
        table td {
            white-space: normal !important;
            padding: 8px;
            font-size: 14px;
        }

        .btn-sm {
            padding: 3px 6px;
            font-size: 12px;
        }
    }
</style>

<div class="container" style="min-height: 90vh;">
    <div id="bg-card" class="shadow mt-5" style="background:#fff; padding:25px; border-radius:10px; margin-top:120px;">

        <h2 class="text-center mb-4">My Upcoming Appointments</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Patient</th>
                        <th>Phone</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody id="appointments-body">

                    {% for app in appointments %}
                        <tr id="row-{{ app.id }}">
                            {% include "components/doctor_appointments_row.html" %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                No upcoming appointments.
                            </td>
                        </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function updateStatus(appId, action) {
    $.ajax({
        url: "{% url 'ajax_update_status' %}",
        type: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        data: {
            appointment_id: appId,
            status: action
        },
        success: function (res) {
            if (res.success) {
                const row = document.getElementById("row-" + res.appointment_id);
                if (row) row.remove();

                const tbody = document.getElementById("appointments-body");
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                No upcoming appointments.
                            </td>
                        </tr>
                    `;
                }
            }
        },
    });
}

$(document).on("click", ".consult-btn", function () {
    updateStatus($(this).data("id"), "consulted");
});

$(document).on("click", ".notconsult-btn", function () {
    updateStatus($(this).data("id"), "not_consulted");
});
</script>

<script>
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
</script>



{% endblock %}
